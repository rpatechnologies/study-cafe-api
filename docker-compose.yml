services:
  mysql:
    image: mysql:8.0
    container_name: studycafe-mysql
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: studycafe_db
    ports:
      # 3307 on host so dev (npm run dev) hits Docker MySQL even when local MySQL uses 3306
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./infrastructure/mysql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: studycafe-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  api-gateway:
    build: ./services/api-gateway
    container_name: studycafe-api-gateway
    ports:
      - "3000:3000"
    environment:
      PORT: 3000
      AUTH_SERVICE_URL: http://auth-service:4001
      COURSE_SERVICE_URL: http://course-service:4002
      ORDER_SERVICE_URL: http://order-service:4003
      ADMIN_SERVICE_URL: http://admin-service:4004
      PLATFORM_SERVICE_URL: http://platform-service:4005
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-studycafe-jwt-secret-change-in-production}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  auth-service:
    build: ./services/auth-service
    container_name: studycafe-auth-service
    ports:
      - "4001:4001"
    environment:
      PORT: 4001
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: studycafe_user
      MYSQL_PASSWORD: studycafe_pass
      MYSQL_DATABASE: studycafe_db
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET:-studycafe-jwt-secret-change-in-production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-studycafe-refresh-secret}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-studycafe-internal-key}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./services/auth-service:/app
      - /app/node_modules

  course-service:
    build: ./services/course-service
    container_name: studycafe-course-service
    ports:
      - "4002:4002"
    environment:
      PORT: 4002
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: studycafe_user
      MYSQL_PASSWORD: studycafe_pass
      MYSQL_DATABASE: studycafe_db
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-studycafe-internal-key}
    depends_on:
      mysql:
        condition: service_healthy

  order-service:
    build: ./services/order-service
    container_name: studycafe-order-service
    ports:
      - "4003:4003"
    environment:
      PORT: 4003
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: studycafe_user
      MYSQL_PASSWORD: studycafe_pass
      MYSQL_DATABASE: studycafe_db
      REDIS_URL: redis://redis:6379
      AUTH_SERVICE_URL: http://auth-service:4001
      ADMIN_SERVICE_URL: http://admin-service:4004
      RAZORPAY_KEY_ID: ${RAZORPAY_KEY_ID:-}
      RAZORPAY_KEY_SECRET: ${RAZORPAY_KEY_SECRET:-}
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-studycafe-internal-key}
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  admin-service:
    build: ./services/admin-service
    container_name: studycafe-admin-service
    ports:
      - "4004:4004"
    environment:
      PORT: 4004
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: studycafe_user
      MYSQL_PASSWORD: studycafe_pass
      MYSQL_DATABASE: studycafe_db
      AUTH_SERVICE_URL: http://auth-service:4001
      COURSE_SERVICE_URL: http://course-service:4002
      PLATFORM_SERVICE_URL: http://platform-service:4005
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-studycafe-internal-key}
    depends_on:
      mysql:
        condition: service_healthy
      platform-service:
        condition: service_started

  platform-service:
    build: ./services/platform-service
    container_name: studycafe-platform-service
    ports:
      - "4005:4005"
    environment:
      PORT: 4005
      MYSQL_HOST: mysql
      MYSQL_PORT: 3306
      MYSQL_USER: studycafe_user
      MYSQL_PASSWORD: studycafe_pass
      MYSQL_DATABASE: studycafe_db
      INTERNAL_API_KEY: ${INTERNAL_API_KEY:-studycafe-internal-key}
    depends_on:
      mysql:
        condition: service_healthy

volumes:
  mysql_data:
